{% extends 'base.html' %}

{% block title %}Home{% endblock %}

<!-- flex -->
{% block content %}

    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            <ul>
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <div>
        {% if not result %}
            <div class="base_container2">
                <div class="base_container21">
                    <div class="base_container2_item1">
                        <h1>{{ dataset }}</h1>
                        <p>Jumlah Data</p>
                    </div>
                    <div class="base_container2_item2">
                        <h1>Title</h1>
                        <p>Summary</p>
                    </div>
                    <div class="base_container2_item3">
                        <h1>Title</h1>
                        <p>Summary</p>
                    </div>
                    <div class="base_container2_item4">
                        <h1>Title</h1>
                        <p>Summary</p>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; align-items: center; padding-bottom: 20px;">
                    <img src="{{ url_for('static', filename='img/banner.png') }}" alt="gambar" style="width: 250px; margin-right: 20px;">
                    <div class="base_container3">
                        <h2>‚ú® Hey Kamu, Yes Kamu! ‚ú®</h2>
                        <h2>Selamat Datang di Zona Solusi! üöÄ</h2>
                        <p><strong>Organisasi kamu ada masalah? Santai,</strong> <br> 
                        Kita siap bantu cari solusi terbaik buat nyelesain konflikmu üí°.</p>
                    </div>
                </div>
            </div>
                
                
        {% endif %}
        <form class="area_container" method="POST">
            <div style="padding: 10px;">
                <textarea name="apa" id="apa" placeholder="Apa masalahta" oninput="autoResize(this)" required></textarea>
                <button type="submit">üîç Cari Solusi</button>
            </div>
        </form>


{% if result %}
    <div class="results-section">

        {% if result.warning %}
            <div class="warning-box">
                <h3>‚ö† {{ result.warning.title }}</h3>
                <p>{{ result.warning.message }}</p>
                
                {% if result.warning.suggestions %}
                <div class="suggestions">
                    <h4>Saran:</h4>
                    <ul>
                        {% for suggestion in result.warning.suggestions %}
                        <li>{{ suggestion }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if result.warning.examples %}
                    <div class="examples">
                        <h4>Contoh Input Valid:</h4>
                        <ul>
                            {% for example in result.warning.examples %}
                            <li>{{ example }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {% if result.error %}
            <div class="error-alert">
                <h3>‚ùå Error Sistem</h3>
                <p>{{ result.error }}</p>
                <p>Silakan coba input yang berbeda atau hubungi admin</p>
            </div>
        {% endif %}


        {% if result.conflicts %}



        <div class="debug-section">
            <h3>üìä Berdasarkan dari analisis system</h3>
            <div class="log-section">
                <h4>Input yang Diproses:</h4>
                <p>{{ result.log.processed_input }}</p>
                
                <h4>Kata Kunci Terdeteksi:</h4>
                <div>
                    {% for keyword in result.log.keywords_found %}
                    <span class="keyword-tag">{{ keyword }}</span>
                    {% endfor %}
                </div>
                
                <h4>Kecocokan Dependensi:</h4>
                <ul>
                    {% for match in result.log.dependency_matches %}
                    <li>{{ match }}</li>
                    {% endfor %}
                </ul>
                <h4>Kecocokan Pola:</h4>
                {% if result and result.log.matched_patterns %}
                    <div class="matches-section">
                        <h4>Analisa NER</h4>
                        
                        <div class="matches-grid">
                            {% for entity, label in result.log.matched_patterns %}
                                <div class="match-card">
                                    <div class="entity-label">{{ label }}</div>
                                    <div class="entity-text">{{ entity }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
            <div class="conflict-results">

                <h2>Hasil Analisis system</h2>

                {% for conflict in result.conflicts %}




                    <div class="conflict-card">
                        <h3>{{ conflict.name }} <span class="solution-score">{{ "%.2f"|format(conflict.score) }}</span></h3>

                            
                        <div class="calculation-formula">
                            <div class="formula-header">
                                <span class="formula-icon">üßÆ</span>
                                <h4>Rincian Perhitungan Matematis</h4>
                            </div>
                            
                            <div class="formula-grid">


                                <div class="formula-row semantic-sim">
                                    <div class="formula-label">
                                        Kemiripan Semantik
                                        <button class="detail-toggle" onclick="toggleDetails('semantic-details')">‚ñº</button>
                                        <span class="formula-tooltip" title="Kemiripan makna menggunakan model bahasa">
                                            ‚ÑπÔ∏è
                                        </span>
                                    </div>
                                    <div class="formula-value">
                                        {{ "%.2f"|format(conflict.debug.semantic_sim|default(0)) }}
                                    </div>
                                </div>


                                <div class="formula-row base-sim">
                                    <div class="formula-label">
                                        Kemiripan Dasar
                                        <button class="detail-toggle" onclick="toggleDetails('base-details')">‚ñº</button>
                                        <span class="formula-tooltip" title="Jumlah kata yang sama dibagi total kata unik">
                                            ‚ÑπÔ∏è
                                        </span>
                                    </div>
                                    <div class="formula-value">
                                        {{ "%.2f"|format(conflict.base_sim|default(0)) }}
                                    </div>
                                </div>
                        
                                <div class="calculation-details" id="base-details">


                                    <div class="detail-item">
                                        <span>Teknologi:</span>
                                        <code>Gensim Word Vectors (cc.id.300.vec)</code>
                                    </div>
                                    <div class="detail-item">
                                        <span>Skor Semantic:</span>
                                        {{ "%.2f"|format(conflict.debug.semantic_sim|default(0)) }}
                                    </div>

                                    <div class="detail-item">
                                        <span>Input User:</span>
                                        <code>{{ conflict['debug'].input_tokens|default(['Tidak ada data'], true)|join(', ') }}</code>
                                    </div>
                                    <div class="detail-item">
                                        <span>Contoh Konflik:</span>
                                        <code>{{ conflict['debug'].example_tokens|default(['Tidak ada data'], true)|join(', ') }}</code>
                                    </div>
                                    <div class="detail-item">
                                        <span>Kata Sama:</span>
                                        <code>{{ conflict.debug.matched_tokens|join(', ') }}</code>
                                        ({{ conflict.debug.matched_count }} kata)
                                    </div>
                                    <div class="detail-item">
                                        <span>Total Kata Unik:</span>
                                        <code>{{ conflict.debug.total_tokens }}</code>
                                    </div>
                                    <div class="detail-item formula">
                                        {{ conflict.debug.matched_count }} / {{ conflict.debug.total_tokens }} = 
                                        {{ "%.2f"|format(conflict.base_sim|default(0)) }}
                                    </div>
                                </div>
                        
                                <div class="formula-row entity-boost">
                                    <div class="formula-label">
                                        Bonus Entitas Khusus
                                        <button class="detail-toggle" onclick="toggleDetails('entity-details')">‚ñº</button>
                                        <span class="formula-tooltip" title="Entitas penting yang terdeteksi">
                                            ‚ÑπÔ∏è
                                        </span>
                                    </div>
                                    <div class="formula-value">
                                        + {{ "%.2f"|format(conflict.entity_boost|default(0)) }}
                                    </div>
                                </div>
                        
                                <div class="calculation-details" id="entity-details">
                                    <div class="detail-item">
                                        <span>Entitas Terdeteksi:</span>
                                        <code>{{ conflict.debug.detected_entities|join(', ') }}</code>
                                    </div>
                                    <div class="detail-item">
                                        <span>Aturan Bonus:</span>
                                        Setiap entitas khusus memberikan bonus 0.30
                                    </div>
                                    <div class="detail-item formula">
                                        {{ conflict.debug.entity_count }} entitas √ó 0.30 = 
                                        {{ "%.2f"|format(conflict.entity_boost|default(0)) }}
                                    </div>
                                </div>
                        
                                <div class="formula-row subtotal">
                                    <div class="formula-label">
                                        Sub Total
                                        <span class="formula-tooltip" title="Penjumlahan dasar + bonus">
                                            ‚ÑπÔ∏è
                                        </span>
                                    </div>
                                    <div class="formula-value">
                                        = {{ "%.2f"|format((conflict.base_sim|default(0) + conflict.entity_boost|default(0))|round(2)) }}
                                    </div>
                                </div>
                        
                                {% if conflict.relation_weight|default(1.0) != 1.0 %}
                                <div class="formula-row relation-weight">
                                    <div class="formula-label">
                                        Bobot Relasi
                                        <button class="detail-toggle" onclick="toggleDetails('relation-details')">‚ñº</button>
                                        <span class="formula-tooltip" title="Jenis hubungan yang mempengaruhi skor">
                                            ‚ÑπÔ∏è
                                        </span>
                                    </div>
                                    <div class="formula-value">
                                        √ó {{ "%.2f"|format(conflict.relation_weight|default(1.0)) }}
                                    </div>
                                </div>
                        
                                <div class="calculation-details" id="relation-details">
                                    <div class="detail-item">
                                        <span>Jenis Relasi:</span>
                                        {{ conflict['debug'].relation_type|default('Tidak ada relasi') }}
                                    </div>
                                    <div class="detail-item">
                                        <span>Bobot Default:</span>
                                        1.00
                                    </div>
                                    <div class="detail-item">
                                        <span>Aturan:</span>
                                        {{ conflict.debug.relation_description }}
                                    </div>
                                </div>
                                {% endif %}
                                <div class="formula-row final-score">
                                    <div class="formula-label">
                                        Skor Akhir
                                        <span class="formula-tooltip" title="Hasil akhir setelah semua faktor">
                                            ‚ÑπÔ∏è
                                        </span>
                                    </div>
                                    <div class="formula-value">
                                        = {{ "%.2f"|format(conflict.score|default(0)) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if conflict.relations %}
                            <div class="related-factors">
                                <h4>Faktor Terkait:</h4>
                                <ul>
                                    {% for rel in conflict.relations %}
                                        <li>{{ rel }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% if result.solutions %}
            <div class="solutions-section">
                <h3>Rekomendasi Solusi</h3>
                <ul class="solution-list">
                    {% for solution, score in result.solutions %}
                        <li class="solution-item">
                            <div class="solution-text">{{ solution }}</div>
                            <div class="solution-score">{{ "%.2f"|format(score) }}</div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% if result.relations %}
            <div class="relations-section">
                <h3>Hubungan relasi</h3>
                <ul class="relation-list">
                    {% for rel, type, score in result.relations %}
                        <li class="relation-item">
                            <span class="relation-type {{ type }}">{{ type }}</span>
                            <span class="relation-content">{{ rel }}</span>
                            <span class="solution-score">{{ "%.2f"|format(score) }}</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}


    </div>
{% endif %}

    </div>

{% endblock %}


